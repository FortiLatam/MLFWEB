<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="fkemps@fortinet.com">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab - API Protection - FortiWeb Machine Learning</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab - API Protection";
    var mkdocs_page_input_path = "fwb-machinelearning-api.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> FortiWeb Machine Learning</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../fwb-machinelearning-refresh/">Info - Machine Learning</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/">Preparation (mandatory)</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../fwb-machinelearning-basic/">Demo - Anomaly Detection</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../fwb-machinelearning-bot-basic/">Demo - Bot Detection</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../fwb-machinelearning-advanced/">Lab - Anomaly Detection</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Lab - API Protection</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#1-lab-scope">1. Lab Scope</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-configuration-setup">2. Configuration Setup</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#21-enable-api-protection">2.1 Enable API Protection</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#23-api-protection-cli-settings">2.3 API Protection CLI settings</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#24-api-protection-configuration">2.4. API Protection Configuration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3-build-api-protection-model">3. Build API Protection Model</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#31-checking-the-model">3.1 Checking the Model</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4-launch-api-attacks">4. Launch API Attacks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#411-api-body-violation">4.1.1 API Body Violation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#412-api-body-violation">4.1.2 API Body Violation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#413-url-query-param-violation">4.1.3 URL query param violation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#414-url-query-param-violation">4.1.4 URL query param violation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#421-command-injection-in-url">4.2.1 Command injection in URL</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#422-command-injection-in-json">4.2.2 Command injection in JSON</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#423-zero-day-in-json">4.2.3 Zero-day in JSON</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#43-xss-in-json">4.3 XSS in JSON</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#44-additional-url-parameter">4.4 Additional URL parameter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#45-out-of-order-json-parameter">4.5 Out of order JSON parameter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#46-non-json">4.6 Non JSON</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#additional-use-cases">Additional Use Cases</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#additional-json-parameter">Additional JSON parameter</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#double-blended-attack">Double blended attack</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#changing-http-method">Changing HTTP method</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#recommendations">Recommendations</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#api-learning-new-method">API Learning new method</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#restricting-api-learning-paths">Restricting API learning Paths</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#api-model-false-positive">API Model False Positive</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
      <div class="navcenterfabric">
        <img src="../img/fabric-small.png">
      </div>
      <div class="navcenter">
        <img src="../img/fortinetlogonav.png">
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">FortiWeb Machine Learning</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Lab - API Protection</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="machine-learning-api-protection">Machine Learning - API Protection</h1>
<p><h7 style="color:red;"> 
NOTE: Current version of ML-API Protection supports RESTFul API using JSON parameters. </h7></p>
<h2 id="1-lab-scope">1. Lab Scope</h2>
<p>The scope of the workshop is to configure and gain more in-depth understanding of <strong>Machine Learning - API Protection</strong>.         </p>
<p>In this exercise we will:</p>
<ul>
<li>Build an API Protection Schema from legitimate  </li>
<li>Send traffic that violates the schema</li>
<li>Check the Attack for each type of attack.</li>
</ul>
<p>During the exercise we will use web application <strong>http://dvwa.fortinet.demo/login.php</strong> and JSON parameters for example:</p>
<p><code>curl -v -X POST -d '{"name":"john","number":"1"}' http://dvwa.fortinet.demo/login.php?username=11 -H "Content-Type: application/json"</code></p>
<p><strong>SSH into the Lubuntu Client, if you want to Cut &amp; Paste the Curl commands.</strong></p>
<p>In the example above we following API Endpoint anatomy: </p>
<ul>
<li>Method: <strong>POST</strong></li>
<li>URL: <strong>dvwa.fortinet.demo/login.php</strong></li>
</ul>
<p>API-endpoint data:</p>
<ul>
<li>URL Parameter: <strong>username</strong></li>
</ul>
<hr />
<h2 id="2-configuration-setup">2. Configuration Setup</h2>
<p><h7 style="color:red;">NOTE: Make sure you have done the "Preparation (mandatory)" first, to complete the environment setup! <br />
NOTE: Make sure Machine Learning - Bot Detection is in "Stop" state!</h7></p>
<p>Then environment is already partly configured and we walk you through it.</p>
<p>Pre-check, to make sure your DVWA is up, check the following:</p>
<p><img alt="" src="../img/fwb-api-ml-precheck1.png" /></p>
<p><img alt="" src="../img/fwb-api-ml-precheck2.png" /></p>
<h4 id="21-enable-api-protection">2.1 Enable API Protection</h4>
<p>Machine Learning can be enabled on a per Server Policy basis and already enabled for the Finance application.</p>
<ul>
<li>Policy &gt; Server Policy &gt; <strong>dvwa</strong><ul>
<li>Web Protection Profile: <strong>Inline Alert Only</strong> </li>
<li><strong>OK</strong> (Make sure you click OK to save, in case you needed to change profile selection.)</li>
</ul>
</li>
</ul>
<p><strong><em>The following steps were performed to enable API Protection</em></strong>   </p>
<p><img alt="" src="../img/fwb-api-ml-enable1.png" /></p>
<p>The three Machine Learning features of FortiWeb, are now shown. Select the API Protection and click the "+" button.</p>
<p><img alt="" src="../img/fwb-api-ml-enable2.png" /></p>
<ul>
<li>Allow sample collection for domain: <strong>dvwa.fortinet.demo</strong></li>
<li>Enter a <strong>Trusted</strong> IP address range. This is needed to create the ML-API protection based on legitimate sources. This should always be done by a trusted host or hosts only. <strong>This is a Mandatory setting!</strong></li>
<li>OK </li>
</ul>
<p><img alt="" src="../img/fwb-api-mlp1.png" /></p>
<p><strong>The pre-configured Server Policy should be as shown below</strong>   </p>
<p><img alt="" src="../img/fwb-api-mlp2.png" />  </p>
<h4 id="23-api-protection-cli-settings">2.3 API Protection CLI settings</h4>
<p>FortiWeb will apply logic to learn legitimate good API traffic from a <strong>single or multiple trusted source IP's.</strong></p>
<p>By default, FortiWeb will build an ML-API Protection model, based on 10+1 unique samples. This is because of CLI parameter <strong>start-training-cnt</strong> default is <strong>10</strong>.</p>
<pre><code class="language-script">config waf api-learning-policy                                                                                                
  edit 1                                                                                                                      
    set policy-id 3064114931877823360                                                                                         
    config  api-ip-list                                                                                                       
      edit 1                                                                                                                  
        set ip 10.2.2.1-10.2.2.254                                                                                             
      next                                                                                                                    
    end                                                                                                                       
    set start-training-cnt 10                                                                                                 
  next                                                                                                                        
end                                                                                                                           
</code></pre>
<!--- add an empty line --->
<p> </p>

<p><h7 style="color:red;"> NOTE: As this is a first version on ML-API without deep-learning, it is recommended:</p>
<ul>
<li>
<p><strong>That traffic learning should be done under QA environment.</h7></strong></p>
</li>
<li>
<p><strong>Set the "start-training-cnt" parameter according to the application.</strong> (Preconfigured by default 10)</p>
</li>
</ul>
<h4 id="24-api-protection-configuration">2.4. API Protection Configuration</h4>
<p>We will no configure the policy to Alert &amp; Deny bad API requests.</p>
<ul>
<li>Go to Machine Learning -&gt; API Protection<ul>
<li>Open the DVWA Policy by double clicking the Name. </li>
</ul>
</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-setting1.png" /></p>
<ul>
<li>Please change the Action Settings from Default "Alert" to "Alert &amp; Deny"</li>
<li>OK</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-setting.png" /></p>
<p>After selecting OK you will return to the the Server Policy screen again.</p>
<ul>
<li>Go to Machine Learning -&gt; API Protection<ul>
<li>Open the DVWA Policy by double clicking the Name.</li>
</ul>
</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-setting1.png" /></p>
<ul>
<li>To open the current blank profile before we learn traffic.<ul>
<li>Click on the View Domain Data</li>
</ul>
</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-setting3.png" /></p>
<p>We have a blank policy in which to build the API Protection automatically.</p>
<p><img alt="" src="../img/fwb-api-ml-setting4.png" /></p>
<p>This shows the Views of the Learning and Running status of Machine Learning. </p>
<p>Please check there are no Machine Learning Events.</p>
<hr />
<h2 id="3-build-api-protection-model">3. Build API Protection Model</h2>
<p>API requests can be generated with the api-legit.sh script on the Lubuntu Client.</p>
<ul>
<li>Open a terminal on Lubuntu client</li>
<li>Start Menu &gt; System Tools &gt; QTerminal</li>
<li>Start API request script</li>
</ul>
<p><code>./api-legit.sh</code></p>
<p><strong>Note: DVWA is not an API application, we are sending API JSON based traffic to get a 200 OK for each API request. <br />
This is mandatory to learn the Model.</strong></p>
<p>An example API JSON request is below:</p>
<p>curl -v -X POST -d '{"name":"john","number":"1"}' http://dvwa.fortinet.demo/login.php?username=11 -H <strong>"Content-Type: application/json"</strong></p>
<p><strong>Note: Content-Type must be application/json</strong></p>
<p>Below is a snip of the DVWA HTML response:</p>
<pre><code class="language-script">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;

&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;

    &lt;head&gt;

        &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;

        &lt;title&gt;Damn Vulnerable Web App (DVWA) - Login&lt;/title&gt;

        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;dvwa/css/login.css&quot; /&gt;

    &lt;/head&gt;

    &lt;body&gt;
</code></pre>
<p>After the api-legit.sh script has run, the API learned Model will be complete.</p>
<p><img alt="" src="../img/fwb-api-ml-model.png" /></p>
<p>Now the model is created we can review the Tree View learned.</p>
<p><img alt="" src="../img/fwb-api-ml-tree1.png" /></p>
<ul>
<li>Click on the POST Method learned, to show the "Parameters" learned tab:</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-tree2.png" /></p>
<ul>
<li>Click on the URL query parameter "username", to reveal the URL query parameter details</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-tree3.png" /></p>
<ul>
<li>Click on the Body tab to see the properties of the JSON parameters.</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-tree4.png" /></p>
<ul>
<li>FortiWeb ML-API learned the two JSON parameters for the URL query parameter "username", they are as follows:<ul>
<li>"name", which is a string of maxlength 6 and minlength 2</li>
<li>"number", which is a string of maxlength 2 and minlength 1</li>
</ul>
</li>
<li>This means any API data sent to the name property must be between 2 and 6 chars, anything more or less will violate the schema and be blocked.</li>
<li>Additionally if API data sent to the number property is is not either 1 or 2 chars long it will also violate the schema and be blocked. </li>
</ul>
<p>API View</p>
<p><img alt="" src="../img/fwb-api-ml-apiview0a.png" /></p>
<ul>
<li>You can display the full ML-API schema details by double clicking on the POST Button for the POST Method entity "/login.php"</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-apiview0.png" /></p>
<ul>
<li>The URL query parameter "username" is <strong>Required</strong>. This is mandatory for the schema validation.</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-apiview.png" /></p>
<ul>
<li>A more granular way is to use the Export button</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-apiview1.png" /></p>
<ul>
<li>You chose the format and the path and method</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-apiview2.png" /></p>
<ul>
<li>The differences between the formats is as follows:</li>
</ul>
<p><img alt="" src="../img/fwb-api-ml-schema.png" /></p>
<h3 id="31-checking-the-model">3.1 Checking the Model</h3>
<p>Let's check the ML-API model is valid:</p>
<p><code>curl -v -X POST -d '{"name":"fred","number":"12"}' http://dvwa.fortinet.demo/login.php?username=12 -H "Content-Type: application/json"</code></p>
<p>This is a legitimate request which contains new valid JSON &amp; URL parameters, and should not be blocked. Let's check the Attack and the Traffic logs.</p>
<p><img alt="" src="../img/fwb-api-ml-alog.png" /></p>
<p>As the request was valid, there is no entry in the Attack Log.</p>
<p><img alt="" src="../img/fwb-api-ml-tlog.png" /></p>
<p>Within the Traffic Log, we are able to see the valid request, including both the HTTP return code 200 and the raw body of the request.</p>
<p><strong>Note: ML-API will only build the model with requests that return an HTTP 2xx code</strong></p>
<hr />
<!--- Comment --->

<h2 id="4-launch-api-attacks">4. Launch API Attacks</h2>
<p>Launch attacks against the ML-API model. It's best to clear the Attack log after each attack, this will make it easier to see what is causing the attack to be blocked. </p>
<p>On the Lubuntu Client or via an ssh terminal.</p>
<ul>
<li>Open a terminal on Lubuntu client</li>
<li>Start Menu &gt; System Tools &gt; QTerminal</li>
<li>Copy and paste each API attack Curl command and run.</li>
</ul>
<p><strong>Note: The Web Protection Profile being used ins "Inline Alert Only"</strong></p>
<p>Example attacks are as follows:</p>
<h3 id="411-api-body-violation">4.1.1 API Body Violation</h3>
<ul>
<li>"Number" JSON parameter is missing in JSON body. Expected result is a body violation.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"cloe"}' http://dvwa.fortinet.demo/login.php?username=11 -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog.png" /></p>
<h3 id="412-api-body-violation">4.1.2 API Body Violation</h3>
<ul>
<li>"name" JSON parameter is too long. Expected result, JSON parameter length violation.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"ABCDEFGHIJ","number":"12"}' http://dvwa.fortinet.demo/login.php?username=12 -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog1.png" /></p>
<h3 id="413-url-query-param-violation">4.1.3 URL query param violation</h3>
<ul>
<li>"username" URL query parameter is too long. Expected result is a parameter violation.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"cloe","number":"12"}' http://dvwa.fortinet.demo/login.php?username=abcdefghijk -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog2.png" /></p>
<h3 id="414-url-query-param-violation">4.1.4 URL query param violation</h3>
<ul>
<li>"username" URL query parameter is too short. Expected result is a parameter violation.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"cloe","number":"12"}' http://dvwa.fortinet.demo/login.php?username=a -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog3.png" /></p>
<h3 id="421-command-injection-in-url">4.2.1 Command injection in URL</h3>
<ul>
<li>"username" URL query parameter will carry a Command Injection attack. Expected result, first signature violation (in Alert mode) and ML-API URL violation.  </li>
</ul>
<p><code>curl -v -X POST -d '{"name":"john","number":"1"}' http://dvwa.fortinet.demo/login.php?username='cmd.exe' -H "Content-Type: application/json"</code></p>
<p>This attack creates two entries into the Attack log. 
<img alt="" src="../img/fwb-api-attack-alog4.png" /></p>
<p>As the Web Protection Profile is set to Inline Alert Only, this attack would've been blocked by known signatures within FortiWeb. Signatures are updated from FortiGuard Labs.</p>
<p><img alt="" src="../img/fwb-api-attack-alog5.png" /></p>
<p>The Attack has been blocked by ML-API, this is because the URL query parameter ML-API model has maxlength = 3 and the URL query parameter request is injecting 7 characters. And as such violates the schema, and is blocked.</p>
<p><img alt="" src="../img/fwb-api-attack-alog6.png" /></p>
<h3 id="422-command-injection-in-json">4.2.2 Command injection in JSON</h3>
<ul>
<li>"name" JSON parameter will carry a Command Injection attack. Expected result is a body violation.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"cmd.exe","number":"1"}' http://dvwa.fortinet.demo/login.php?username='11' -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog7.png" /></p>
<h3 id="423-zero-day-in-json">4.2.3 Zero-day in JSON</h3>
<ul>
<li>"name" JSON parameter will carry a Zero Day attack. Expected result, JSON parameter violation.</li>
</ul>
<p><code>curl -X POST -d '{"name":"fred","number":"xx&amp; var1=l var2=s ; "$var1""$var2""}' http://dvwa.fortinet.demo/login.php?username=12 -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog12.png" /></p>
<h3 id="43-xss-in-json">4.3 XSS in JSON</h3>
<ul>
<li>"name" JSON parameter will carry an XSS attack. Expected result, JSON body violation.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"&lt;script&gt;alert(123)&lt;/script&gt;","number":"1"}' http://dvwa.fortinet.demo/login.php?username='22' -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog9.png" /></p>
<h3 id="44-additional-url-parameter">4.4 Additional URL parameter</h3>
<ul>
<li>URL will carry "usernameB" as an additional URL query parameter. Expected result, additional query parameter not allowed.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"john","number":"1"}' 'http://dvwa.fortinet.demo/login.php?username=11&amp;usernameB=11B' -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog11.png" /></p>
<h3 id="45-out-of-order-json-parameter">4.5 Out of order JSON parameter</h3>
<ul>
<li>JSON parameters will be sent in a <strong>new</strong> order. Expected result, parameter location violating the schema.</li>
</ul>
<p><code>curl -v -X POST -d '{"number”:"11","name”:"Rafa"}' http://dvwa.fortinet.demo/login.php?username=111 -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog13.png" /></p>
<p><strong>Note: ML-API was coded to respect "propertyOrder" JSON validation.</strong></p>
<h3 id="46-non-json">4.6 Non JSON</h3>
<ul>
<li>Non JSON content-type attack or deviation, will not be detected by ML-API Model.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"ABCDEFGHIJ","number":"12"}' http://dvwa.fortinet.demo/login.php?username=12 -H "Content-Type: application/xml"</code></p>
<p><img alt="" src="../img/fwb-api-ml-alog7a.png" /></p>
<ul>
<li>Traffic log is showing FortiWeb is allowing the non JSON request.</li>
</ul>
<h3 id="additional-use-cases">Additional Use Cases</h3>
<h4 id="additional-json-parameter">Additional JSON parameter</h4>
<ul>
<li>"numberB" additional JSON parameter will be sent. Expected result, no violation as additionalProperties JSON validation is NOT set by ML-API model.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"john","number":"1","numberB":"1b"}' http://dvwa.fortinet.demo/login.php?username=11 -H "Content-Type: application/json"</code></p>
<p>This page is passed, without violating the API Schema, as the ML-API model is unaware of the new JSON parameter being sent.</p>
<p><img alt="" src="../img/fwb-api-attack-alog10.png" /></p>
<h4 id="double-blended-attack">Double blended attack</h4>
<ul>
<li>The following is an example of double blended attack inside both JSON parameter and URL query parameter. </li>
<li>Expected result, ML-API will block the request due to URL query parameter length violation.</li>
</ul>
<p><strong>Note: Attack log will show 4 events, the first are due to the Web Protection Profile being set to Inline Alert Only. This will show both signature and HTML Tag Based XSS Injection , none are blocked due to being in Alert mode.</strong></p>
<p><code>curl -v -X POST -d '{"name":"cmd.exe","number":"1"}' http://dvwa.fortinet.demo/login.php?username='&lt;script&gt;alert(hacked)&lt;/script&gt;' -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog15.png" />
<img alt="" src="../img/fwb-api-attack-alog16.png" /></p>
<h4 id="changing-http-method">Changing HTTP method</h4>
<ul>
<li>The following is an example of changing the HTTP method, from a POST to a GET.</li>
<li>Expected result, ML-API will allow the request due to not be part of the existing model.</li>
<li>To block this request you would need to build a new ML-API model for the HTTP GET method.</li>
</ul>
<p><code>curl -v -X GET -d '{"name":"cloe","number":"5"}' http://dvwa.fortinet.demo/login.php?name=11 -H "Content-Type: application/json"</code></p>
<ul>
<li>From within the Traffic log you will see FortiWeb is allowing the request</li>
</ul>
<p><img alt="" src="../img/fwb-api-attack-tlog1.png" /></p>
<h3 id="recommendations">Recommendations</h3>
<h4 id="api-learning-new-method">API Learning new method</h4>
<p>API GET requests can be generated with the api-get.sh script on the Lubuntu Client.</p>
<ul>
<li>Open a terminal on Lubuntu client</li>
<li>Start Menu &gt; System Tools &gt; QTerminal</li>
<li>Start API request script</li>
</ul>
<p><code>./api-get.sh</code></p>
<p><img alt="" src="../img/fwb-api-get1.png" /></p>
<ul>
<li>Expected result as above shows the newly learned ML-API model for the GET method.</li>
</ul>
<p><img alt="" src="../img/fwb-api-get2.png" /></p>
<ul>
<li>The Tree View is now showing the GET method and JSON body parameters.</li>
</ul>
<h4 id="restricting-api-learning-paths">Restricting API learning Paths</h4>
<p><strong>Note: This should be set FIRST, before traffic learning</strong>
* You can create a list of paths within the application where you want ML-API to learn.
* Follow the example to setup</p>
<p><img alt="" src="../img/fwb-api-ml-patterns1.png" />
<img alt="" src="../img/fwb-api-ml-patterns2.png" />
<img alt="" src="../img/fwb-api-ml-patterns3.png" />
<img alt="" src="../img/fwb-api-ml-patterns4.png" />
<img alt="" src="../img/fwb-api-ml-patterns5.png" />
<img alt="" src="../img/fwb-api-ml-patterns6.png" /></p>
<ul>
<li>In this example, only traffic matching the path "/upload/api" will be learned.</li>
</ul>
<h4 id="api-model-false-positive">API Model False Positive</h4>
<ul>
<li>In the following example, "name" JSON parameter is longer than 6 characters in ML-API model, is legitimate but it violates the schema.</li>
</ul>
<p><code>curl -v -X POST -d '{"name":"jonathon","number":"1"}' http://dvwa.fortinet.demo/login.php?username='11' -H "Content-Type: application/json"</code></p>
<p><img alt="" src="../img/fwb-api-attack-alog14.png" /></p>
<p><strong>This is not an API attack but a legitimate request, however it exceeds the current maxlength for the JSON "name" parameter. To prevent this as a FALSE POSITIVE, you will need to relearn the API schema by sending new requests with the new maxlength.
Today this is a manual process and is achieved by refreshing the ML-API policy.</strong></p>
<p><img alt="" src="../img/fwb-api-ml-refresh.png" /></p>
<ul>
<li>Just for information purposes.</li>
</ul>
<p>This workshop is now complete.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../fwb-machinelearning-advanced/" class="btn btn-neutral" title="Lab - Anomaly Detection"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>© Fortinet</p>
    
  </div>

  Provided by CSE-team International.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../fwb-machinelearning-advanced/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
